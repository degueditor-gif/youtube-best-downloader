<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT Downloader - Pro Build</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .search-area { background: var(--card); padding: 40px; border-radius: 24px; text-align: center; margin-bottom: 30px; border: 1px solid #334155; }
        input { width: 70%; padding: 15px; border-radius: 12px; border: 1px solid #475569; background: #0f172a; color: #fff; font-size: 16px; outline: none; }
        button { padding: 15px 30px; border-radius: 12px; border: none; background: var(--accent); color: #0f172a; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .video-item { background: var(--card); margin-bottom: 15px; padding: 20px; border-radius: 20px; display: flex; gap: 20px; align-items: center; border: 1px solid #334155; }
        .video-item img { width: 140px; border-radius: 12px; }
        .video-info h4 { margin: 0 0 12px 0; font-size: 16px; }
        select { background: #0f172a; color: #fff; border: 1px solid #475569; padding: 8px; border-radius: 8px; margin-right: 10px; }
        #progress-overlay { position: fixed; bottom: 30px; right: 30px; background: #1e293b; border: 1px solid var(--accent); padding: 20px; border-radius: 20px; display: none; width: 280px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .cancel-link { display: block; margin-top: 10px; text-align: center; font-size: 12px; color: #94a3b8; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-area">
            <h1>YT Downloader <span style="font-size:16px; color:var(--accent)">v3.1</span></h1>
            <input type="text" id="urlInput" placeholder="URLを貼り付け...">
            <button onclick="analyze()">解析</button>
        </div>
        <div id="playlistTools" style="display:none; text-align: right; margin-bottom: 20px; gap: 10px;">
            <button onclick="batch('mp3')" style="background:#475569; color:#fff">全曲MP3保存</button>
            <button onclick="batch('mp4')">全動画MP4保存</button>
        </div>
        <div id="results"></div>
    </div>

    <div id="progress-overlay">
        <div id="statusMsg" style="font-weight:600; font-size:14px; margin-bottom:8px;">準備中...</div>
        <div style="background:#334155; height:8px; border-radius:4px; overflow:hidden;">
            <div id="pBar" style="width:0%; height:100%; background:var(--accent); transition:0.3s;"></div>
        </div>
        <span class="cancel-link" onclick="cancelCurrent()">ダウンロードを中止</span>
    </div>

    <script>
        // Socket.ioの接続設定
        const socket = io({ transports: ['websocket', 'polling'] });
        let currentTask = null;
        let videoData = [];

        socket.on('progress_update', d => {
            document.getElementById('progress-overlay').style.display = 'block';
            document.getElementById('statusMsg').innerText = `${d.status} (${d.percent}%)`;
            document.getElementById('pBar').style.width = d.percent + '%';
        });

        socket.on('task_complete', d => {
            document.getElementById('statusMsg').innerText = "保存完了！";
            document.getElementById('pBar').style.width = '100%';
            setTimeout(() => { document.getElementById('progress-overlay').style.display = 'none'; }, 3000);
            const a = document.createElement('a'); a.href = d.download_url; a.click();
        });

        async function analyze() {
            const url = document.getElementById('urlInput').value;
            const resArea = document.getElementById('results');
            if(!url) return;
            resArea.innerHTML = "<p style='text-align:center'>YouTubeから情報を取得しています...</p>";
            const res = await fetch('/get_info', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url}) });
            const data = await res.json();
            resArea.innerHTML = "";
            if(data.type === 'playlist') {
                document.getElementById('playlistTools').style.display = 'flex';
                document.getElementById('playlistTools').style.justifyContent = 'flex-end';
                videoData = data.videos;
                data.videos.forEach(v => render(v, true));
            } else {
                document.getElementById('playlistTools').style.display = 'none';
                videoData = [data];
                render(data, false);
            }
        }

        function render(v, isPl) {
            const div = document.createElement('div');
            div.className = 'video-item';
            const fmts = !isPl ? `<select id="f-${v.id}">${v.formats.map(f => `<option value="${f.id}">${f.res} [${f.size}]</option>`).join('')}</select>` : '';
            div.innerHTML = `
                <img src="${v.thumbnail}">
                <div class="video-info">
                    <h4>${v.title}</h4>
                    <div style="display:flex; align-items:center; gap:5px;">
                        ${fmts}
                        <button style="padding:8px 15px; font-size:13px;" onclick="add('${v.url}','mp4','${v.title}','${v.id}')">MP4</button>
                        <button style="padding:8px 15px; font-size:13px; background:#475569; color:#fff" onclick="add('${v.url}','mp3','${v.title}','${v.id}')">MP3</button>
                    </div>
                </div>`;
            document.getElementById('results').appendChild(div);
        }

        async function add(url, mode, title, id) {
            const fId = document.getElementById(`f-${id}`)?.value || 'best';
            const res = await fetch('/enqueue', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url, mode, title, format_id:fId}) });
            const data = await res.json();
            currentTask = data.task_id;
        }

        function batch(mode) {
            videoData.forEach(v => add(v.url, mode, v.title, v.id));
        }

        async function cancelCurrent() {
            if(!currentTask) return;
            await fetch('/cancel', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({task_id: currentTask}) });
            document.getElementById('progress-overlay').style.display = 'none';
        }
    </script>
</body>
</html>